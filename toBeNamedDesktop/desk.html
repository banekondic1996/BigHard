<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desk</title>
<style>
    body 
    {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background:url('imgT.jpg'); 
        background-repeat: no-repeat;
        background-size: cover;     
    }
    #select 
    {
        display: none;
        background: #0000005c;
        position: absolute;
        border-radius: 12px;
        left: 184px;
        top: 211px;
        transform-origin: left top;
        z-index: 999;
        /*  height: 171px;
        width: 136px; */
    }
    .desktopIcon{
        display: flex;
        background-color:rgb(255 51 51 / 22%);
        width: 60px;
        height: 60px;
        margin: 3px;
        padding: 5px;
        user-select: none;
    }
    .desktopIconIn
    {
        border-radius: 5px;
        height: 60px;
        width: 60px;
        flex-direction: column;
        align-items: center;
        margin: auto;
        overflow: hidden;
        text-align-last: center;
        user-select: all;
        -webkit-user-drag: element;
        position: absolute;
        z-index: 10;
    }
    .desktopIconIn:hover{
        background-color: rgba(255, 255, 255, 0.268);
        height: auto;
    }
    .desktopIconIn:active{
        background-color: rgba(255, 255, 255, 0.452);
        height: auto;
    }
    .desktopIconIn img{
        user-select: none;
        height: 42px;
        width: 42px;
        user-select: none;
        -webkit-user-drag: none;
    }
    .desktopIconInText{
        margin-top: -6px;
        text-align: center;
        color: white;
        text-shadow: 1px 1px 3px #7c7c7c;
        text-overflow: clip;
        user-select: none;
        -webkit-user-drag: none;
    }
    .icons{
        display: flex;
        background: #fffefe;
        padding: 6px;
    }
    .contextMenu{
        display: none;
        position: absolute;
        /* width: 134px; */
        /* height: 271px; */
        background-color: rgb(228, 228, 228);
        opacity: 0.8;
        border: none;
        border-radius: 10px;
        overflow: hidden;
        z-index: 222;
        /* text-align: center; */
        left: 116px;
        top: 50px;
    }
    .contextMenu tr td{
        border-radius: 10px;
        /* text-align: center; */
        text-wrap: nowrap;
        padding: 8px;
    }
    .contextMenu tr td:hover{
        background:rgb(124, 124, 124);
        text-align: center;
    }
    .contextMenu tr th img:hover{
        border-radius: 100%;
        background:rgb(236, 236, 236);
    }
    .contextMenu tr th img{
        padding:5px;
    }
</style>
</head>
<body>
<!--    ---------Context menu START(change to tag menu in future)------------------ -->
    <div class="contextMenu" id="contextMenuID">
        <table style="width: 100%;display: flex;">
        <tbody style="width: 100%;display: flex;flex-direction: row;align-items: center;">
        <tr onclick="">
            <th style="display: flex;flex-direction: column;">
         <div class="icons" style="display: flex;">
         <img alt="Copy" src="/icons/copy.png" style="height: 24px;">
        </div>
         <div class="icons" style="display: flex;">
        <img alt="Cut" src="/icons/cut.png" style="height: 24px;margin: auto;"></div>
        <div class="icons" style="display: flex;">
        <img alt="Paste" src="/icons/paste.png" style="height: 24px;"></div>
        <div class="icons" style="display: flex;" onmouseenter="console.log('hell');">
        <img alt="Respawn" src="/icons/reload.png" style="height: 24px;" ></div>
        <div class="icons" style="display: flex;">
         <img alt="Settings" src="/icons/settings.png" onclick="openItem('shell:ControlPanelFolder')" style="height: 24px;">
        </div><div class="icons" style="display: flex;">
         <img  alt="New" src="/icons/add.png" style="height: 24px;">
        </div></th>
        </tr>
        </tbody></table>
        </div>
<!--    ---------Context menu END(change to tag menu in future)------------------ -->
<!--    ---------DesktopGrid START(------------------ -->
        <div id="desktopID" style="position: absolute;display: block;height: 100%;width: 100%;"></div>
        <div id="desktopGridID" class="desktopGrid" style="display: flex;height: 93%;width: 100%;margin: auto;flex-direction: row;flex-wrap: wrap;align-items: center;justify-content: center;">
            <div class="desktopIcon" draggable="false"><div id="desktopIcon1" class="desktopIconIn"><img src="/chrome.png" alt=""><div class="desktopIconInText">Google Chrome</div></div></div>
        <div class="desktopIcon" style=""><div class="desktopIconIn"><img src="/chrome.png" alt=""><div class="desktopIconInText">Google Chrome</div></div></div><div class="desktopIcon" style="" draggable="false"><div class="desktopIconIn"><img src="/chrome.png" alt=""><div class="desktopIconInText">Google Chrome</div></div></div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="" draggable="false">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div>
        <div class="desktopIcon" style="" draggable="false">2</div><div class="desktopIcon" draggable="false" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="" draggable="false">1</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="" draggable="false">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div>
        <div class="desktopIcon" draggable="false" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="" draggable="false">1</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="" draggable="false">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div>
        <div class="desktopIcon" draggable="false" style=""></div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="" draggable="false">1</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="" draggable="false">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div>
        <div class="desktopIcon" draggable="false" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="" draggable="false">1</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="" draggable="false">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div>
        <div class="desktopIcon" draggable="false" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="" draggable="false">1</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="" draggable="false">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div>
        <div class="desktopIcon" draggable="false" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="" draggable="false">1</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="" draggable="false">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div>
        <div class="desktopIcon" draggable="false" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="" draggable="false">1</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="" draggable="false">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">1</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div>
        <div class="desktopIcon" draggable="false" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="" draggable="false">1</div><div class="desktopIcon" style=""><div class="desktopIconIn"><img src="/empty_trash.png" alt=""><div class="desktopIconInText">Mr. Bin</div></div></div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="" draggable="false">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div><div class="desktopIcon" style="">2</div>
        </div>
    </div>
    <!--    ---------Desktop Grid END------------------ -->
<!--    ---------Selection START(change to tag menu in future)------------------ -->
<div id="select"></div>
<!--    ---------Selection END(change to tag menu in future)------------------ -->
<script>
    console.log("width="+window.innerWidth);
    let AppProcessID=nw.process.ppid;
    let desktopGridElement=document.getElementById('desktopGridID');
    let desktopGridHeight=desktopGridElement.offsetHeight;
    let desktopGridWidth=desktopGridElement.offsetWidth;
    let desktopGridFields=Math.floor(desktopGridWidth/76)*Math.floor(desktopGridHeight/76);
    let desktopIcons=[
    {
        name:"Google Chrome",
        icon:"/chrome.png",
        gridPosition:0,
        path:"C:/Program Files/BraveSoftware/Brave-Browser/Application/brave.exe"
    },
    {
        name:"Google Chrome",
        icon:"/chrome.png",
        gridPosition:1,
        path:"C:/Program Files/BraveSoftware/Brave-Browser/Application/brave.exe"
    }, 
    {
        name:"Test Window",
        icon:"/icons/testWindow.png",
        gridPosition:60,
        path:""
    },
    {
        name:"Settings",
        icon:"/icons/settingsDesk.png",
        gridPosition:80,
        path:"shell:ControlPanelFolder"
    },
    {
        name:"Mr. Bin",
        icon:"/empty_trash.png",
        gridPosition:179,
        path:"shell:RecycleBinFolder"
    }

    ];
    const os = require('node:os'); //To get OS info
    const { exec } = require('child_process');
    var win=nw.Window.get();
    var iconExtractor = require('icon-extractor');
    var PowerShell = require("node-powershell");
    var bottomShell=new PowerShell.PowerShell;
    let desktopElement=document.getElementById('desktopID');
    var contextMenuElement = document.getElementById('contextMenuID');
    let selectionElement=document.getElementById('select');
    win.resizeTo(1920,1080);
////////////////////////////////////////
    function spawnDesktopGrid()
            {
                desktopGridElement.innerHTML="";
                for(let i=0;desktopGridFields>i;i++)
                {
                    console.log("spawn "+i)
                    desktopGridElement.innerHTML=desktopGridElement.innerHTML+`<div class="desktopIcon" draggable="false" style="">`+i+`</div>`
                    /* Grid.push({cell :i , offsetTop:desktopGridElement.children[i].offsetTop,offsetLeft:desktopGridElement.children[i].offsetLeft}); */
                }
            }
////////////////////////////////////////
    function spawnDesktopIcons()
    {
        desktopIcons.forEach(el => 
        {
            if(el.gridPosition>=0)
            {
                desktopGridElement.children[el.gridPosition].innerHTML=`<div class="desktopIconIn" ondblclick="console.log('`+el.path+`');openItem('`+el.path+`')"><img src="`+el.icon+`" alt=""><div class="desktopIconInText">`+el.name+`</div></div>`;
                dragElement(desktopGridElement.children[el.gridPosition].children[0]);
            }
        });
    }
//////////////////////////////////////// 
function openItem(filePath){
   /*  filePath= filePath.replace("/", "\\"); */
    if(filePath.includes("shell:")){
        const { exec } = require('child_process');
        exec('start '+filePath+'', (error, stdout, stderr) => {
        if (error) {
            console.error(`Error opening: ${error.message}`);
            return;
        }
        if (stderr) {
            console.error(`Standard error: ${stderr}`);
            return;
        }
        console.log('Opened successfully');
        });
    }
    console.log(filePath);
    nw.Shell.openItem(filePath);
}
////////////////////////////////////////        
    function hideDesktopIcons(){spawnDesktopGrid();}
////////////////////////////////////////
    function showDesktopIcons()
    {
        spawnDesktopGrid();
        spawnDesktopIcons();
    }
////////////////////////////////////////
    spawnDesktopGrid();
    spawnDesktopIcons();
////////////////////////////////////////
document.addEventListener('DOMContentLoaded', function () 
{
    var isResizing = false;
    var lastY;
    var lastX;
    var mouseDown=false;

    var contextMenuElement = document.getElementById('contextMenuID');
    ////////////////////////////////////////
    document.addEventListener('contextmenu', function(e) 
    {
        contextMenuElement.style.display="block";
        contextMenuElement.style.left=e.clientX+"px";
        contextMenuElement.style.top=e.clientY+"px";
        /* e.preventDefault(); */
    }, false);
    ////////////////////////////////////////
    //////////////////////////////////////// There's also document.mouseup=null in dragElement function
    document.addEventListener('mouseup', function () 
    {
        isResizing = false;
        mouseDown=false;
        selectionElement.style.display="none";
        console.log("mouseup");
    });
    ////////////////////////////////////////
    window.addEventListener("mousedown", function(event) {
        bottomShell.invokeCommand("C:/Users/X.000000000000000000/Desktop/bottomMe.ps1 "+AppProcessID+" ");
    });
    ///////////////////////////////////////
    document.addEventListener('mousedown', function () 
    {   
        if(event.target.className!="contextMenu"){
        contextMenuElement.style.display="none";
        }
        if (event.target.className != "desktopIconIn")
        {
            console.log("mousedown");
            mouseDown=true;
            selectionElement.style.height="0px";
            selectionElement.style.width="0px";
            selectionElement.style.display="block";
            selectionElement.style.top=event.clientY+"px";
            selectionElement.style.left=event.clientX+"px"; 
        }
        console.log(event);
    });
    ////////////////////////////////////////
    document.addEventListener('mousemove', function () 
    {
        console.log("mousemove");
        if(mouseDown)
        {
            console.log("mousedown & mousemove");
            let selectHeight=event.clientY-selectionElement.offsetTop;
            let selectWidth=event.clientX-selectionElement.offsetLeft;
            if(selectHeight>0&selectWidth>0)
            {
                selectionElement.style.transform="rotate(0deg)";
                selectionElement.style.translate="0%";
                selectionElement.style.height=selectHeight+"px";
                selectionElement.style.width=selectWidth+"px";
            }
            if(selectHeight<0&selectWidth>0)
            {
                selectionElement.style.transform="rotate(180deg)";
                selectionElement.style.translate="100%";
                selectionElement.style.height=Math.abs(selectHeight)+"px";
                selectionElement.style.width=selectWidth+"px";
            }
            if(selectHeight>0&selectWidth<0)
            {
                selectionElement.style.transform="rotate(0deg)";
                selectionElement.style.translate="-100%";
                selectionElement.style.height=selectHeight+"px";
                selectionElement.style.width=Math.abs(selectWidth)+"px";
            }
            if(selectHeight<0&selectWidth<0)
            {
                selectionElement.style.transform="rotate(180deg)";
                selectionElement.style.translate="0%";
                selectionElement.style.height=Math.abs(selectHeight)+"px";
                selectionElement.style.width=Math.abs(selectWidth)+"px";
            }
        console.log("eventY:"+event.clientY);
        console.log("barTop:"+selectionElement.offsetTop);
        }
    });  
});
////////////////////////////////////////
// Make the icon element draggable:
/* let dragableIcons=document.getElementsByClassName("desktopIconIn");
for(let i=0;dragableIcons.length;i++){
    dragElement(dragableIcons[i]);
} */
//////////////////////////////////////// Find closest number in array to given number
function closest(array, num) 
        {
            var i = 0;
            var minDiff = 1000;
            var ans;
            for (i in array)
            {
                var m = Math.abs(num - array[i]);
                if (m < minDiff) 
                {
                    minDiff = m;
                    ans = array[i];
                }
            }
            return ans;
        }
////////////////////////////////////////
function dragElement(elmnt) 
        {
            var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            console.log(elmnt);
            elmnt.onmousedown = dragMouseDown;
            ////////////////////////////////////////
            function dragMouseDown(e) 
            {   
                bottomShell.invokeCommand("C:/Users/X.000000000000000000/Desktop/bottomMe.ps1 "+AppProcessID+" ");
                e.stopPropagation();
                e = e || window.event;
                e.preventDefault();
                // get the mouse cursor position at startup:
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                // call a function whenever the cursor moves:
                document.onmousemove = elementDrag;
            }
            ////////////////////////////////////////
            function elementDrag(e) 
            {
                e = e || window.event;
                e.preventDefault();
                // calculate the new cursor position:
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                // set the element's new position:
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
            }
            //////////////////////////////////////// Not even i know how i made this now, but i was calculating a lot
            function closeDragElement() 
            {
                var cell=Math.round((elmnt.offsetTop)/82)*20+(Math.round((76+elmnt.offsetLeft)/76))-1; //76px and 82px which has to be adjusted for other sizes
                console.log("the element offsetTop= "+elmnt.offsetTop);
                console.log("the element offsetLeft= "+elmnt.offsetLeft);
                console.log("the element row= "+Math.round((76+elmnt.offsetTop)/76)); //76px which has to be adjusted for other sizes
                console.log("the element column= "+Math.round((76+elmnt.offsetLeft)/76)); //76px which has to be adjusted for other sizes
                console.log("Cell ="+cell);
            /*   elmnt.style.top=desktopGridElement.children[cell].offsetTop+"px";
                elmnt.style.left=desktopGridElement.children[cell].offsetLeft+"px"; */
                elmnt.style.top=null;
                elmnt.style.left=null;
                if(desktopGridElement.children[cell].children[0]==null)
                {
                    desktopGridElement.children[cell].append(elmnt);
                }
        // stop moving when mouse button is released:
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }
//////////////////////////////////////// 
</script>
<script src="./Sortable.js"></script>
</body>
</html>